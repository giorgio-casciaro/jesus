'use strict';

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

var R = require('ramda');
// const jesus = require('jesus')
var uuidV4 = require('uuid/v4');
function setPackageArgsOverwrite() {
  var overwriteArgs = Array.prototype.slice.call(arguments, 1);
  var originalPackage = arguments[0];
  var modifiedPackage = {};
  for (var i in originalPackage) {
    modifiedPackage[i] = function packageArgsOverwrite() {
      var modifiedArguments = Object.assign(arguments, overwriteArgs);
      return originalPackage[i].apply(this, modifiedArguments);
    };
  }
  return modifiedPackage;
}
function checkRequiredDependencies(DI, requiredDependenciesNames) {
  if (!DI) {
    throw new Error('Required Dependencies Container is missing');
  }
  requiredDependenciesNames.forEach(function (dependencyName) {
    if (!DI[dependencyName]) {
      throw new Error('Required Dependency ' + dependencyName + ' is missing');
    }
  });
}
function checkRequired(OBJ, propNames) {
  var PACKAGE = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : 'unknow';

  if (!OBJ && propNames.length) {
    throw new Error('PACKAGE ' + PACKAGE + ' -> Required Dependencies Container is missing');
  }
  propNames.forEach(function (propName) {
    if (!OBJ[propName]) {
      throw new Error('PACKAGE ' + PACKAGE + ' -> Required Dependency ' + propName + ' is missing');
    }
  });
  return R.clone(OBJ);
}
function debug() {
  console.log('\x1B[1;33m' + '<State Mutations>' + '\x1B[0m');
  console.log.apply(console, arguments);
}

module.exports = {
  asyncResponse: function asyncResponse() {
    return {};
  },
  getValuePromise: function getValuePromise(value) {
    return new Promise(function (resolve, reject) {
      Promise.resolve(value).then(function (value) {
        if (typeof value === 'function') {
          try {
            resolve(value());
          } catch (error) {
            reject(error);
          }
        } else resolve(value);
      });
    });
  },
  checkRequired: checkRequired,
  checkRequiredDependencies: checkRequiredDependencies,
  createNewIds: R.compose(R.map(function () {
    return uuidV4();
  }), R.repeat(true)),
  debug: debug,
  // debug,
  addObjectColumn: function addObjectColumn(objectsArray, columnName, valuesArray) {
    var addColums = function addColums(val, index) {
      return R.merge(_defineProperty({}, columnName, valuesArray[index]), val);
    };
    return R.addIndex(R.map)(addColums, objectsArray);
  },
  getStoragePackage: R.curry(function (storage, collection) {
    return require('jesus/storage.' + storage.type)(storage, collection);
  }),
  getLogFunctionOld: function getLogFunctionOld(DI) {
    checkRequiredDependencies(DI, ['storage']);
    return R.curry(function (context, type, object) {
      var contextString = context.join(' > ');
      var time = Date.now();
      var readableTime = new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '');
      if (type === 'ERROR') {
        console.log('\x1B[1;33m ' + type + ' ( ' + contextString + ' ) \x1B[0m');
        console.log(object);
        console.trace(object);
      }
      DI.storage.insert([{
        type: type,
        readableTime: readableTime,
        context: context,
        object: object,
        time: time
      }]);
    });
  },
  getLogFunction: function getLogFunction(DI) {
    checkRequiredDependencies(DI, ['storage']);
    return function log(logData) {
      logData = R.merge(logData, {
        readableTime: new Date().toISOString().replace(/T/, ' ').replace(/\..+/, ''),
        type: 'LOG',
        time: Date.now(),
        data: {}
      });
      if (logData.type === 'ERROR') {
        var contextString = logData.context.join(' > ');
        console.log('\x1B[1;33m ' + logData.type + ' ( ' + contextString + ' ) \x1B[0m');
        console.log(logData.data);
        console.trace(logData.data);
      }
      DI.storage.insert([logData]);
    };
  },
  getServiceErrorFunction: function getServiceErrorFunction(DI) {
    checkRequiredDependencies(DI, ['log']);
    return function serviceError(e) {
      DI.log('serviceError', e);
      throw new Error(e);
    };
  }
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImplc3VzLmVzNiJdLCJuYW1lcyI6WyJSIiwicmVxdWlyZSIsInV1aWRWNCIsInNldFBhY2thZ2VBcmdzT3ZlcndyaXRlIiwib3ZlcndyaXRlQXJncyIsIkFycmF5IiwicHJvdG90eXBlIiwic2xpY2UiLCJjYWxsIiwiYXJndW1lbnRzIiwib3JpZ2luYWxQYWNrYWdlIiwibW9kaWZpZWRQYWNrYWdlIiwiaSIsInBhY2thZ2VBcmdzT3ZlcndyaXRlIiwibW9kaWZpZWRBcmd1bWVudHMiLCJPYmplY3QiLCJhc3NpZ24iLCJhcHBseSIsImNoZWNrUmVxdWlyZWREZXBlbmRlbmNpZXMiLCJESSIsInJlcXVpcmVkRGVwZW5kZW5jaWVzTmFtZXMiLCJFcnJvciIsImZvckVhY2giLCJkZXBlbmRlbmN5TmFtZSIsImNoZWNrUmVxdWlyZWQiLCJPQkoiLCJwcm9wTmFtZXMiLCJQQUNLQUdFIiwibGVuZ3RoIiwicHJvcE5hbWUiLCJjbG9uZSIsImRlYnVnIiwiY29uc29sZSIsImxvZyIsIm1vZHVsZSIsImV4cG9ydHMiLCJhc3luY1Jlc3BvbnNlIiwiZ2V0VmFsdWVQcm9taXNlIiwidmFsdWUiLCJQcm9taXNlIiwicmVzb2x2ZSIsInJlamVjdCIsInRoZW4iLCJlcnJvciIsImNyZWF0ZU5ld0lkcyIsImNvbXBvc2UiLCJtYXAiLCJyZXBlYXQiLCJhZGRPYmplY3RDb2x1bW4iLCJvYmplY3RzQXJyYXkiLCJjb2x1bW5OYW1lIiwidmFsdWVzQXJyYXkiLCJhZGRDb2x1bXMiLCJ2YWwiLCJpbmRleCIsIm1lcmdlIiwiYWRkSW5kZXgiLCJnZXRTdG9yYWdlUGFja2FnZSIsImN1cnJ5Iiwic3RvcmFnZSIsImNvbGxlY3Rpb24iLCJ0eXBlIiwiZ2V0TG9nRnVuY3Rpb25PbGQiLCJjb250ZXh0Iiwib2JqZWN0IiwiY29udGV4dFN0cmluZyIsImpvaW4iLCJ0aW1lIiwiRGF0ZSIsIm5vdyIsInJlYWRhYmxlVGltZSIsInRvSVNPU3RyaW5nIiwicmVwbGFjZSIsInRyYWNlIiwiaW5zZXJ0IiwiZ2V0TG9nRnVuY3Rpb24iLCJsb2dEYXRhIiwiZGF0YSIsImdldFNlcnZpY2VFcnJvckZ1bmN0aW9uIiwic2VydmljZUVycm9yIiwiZSJdLCJtYXBwaW5ncyI6Ijs7OztBQUFBLElBQU1BLElBQUlDLFFBQVEsT0FBUixDQUFWO0FBQ0E7QUFDQSxJQUFNQyxTQUFTRCxRQUFRLFNBQVIsQ0FBZjtBQUNBLFNBQVNFLHVCQUFULEdBQW9DO0FBQ2xDLE1BQUlDLGdCQUFnQkMsTUFBTUMsU0FBTixDQUFnQkMsS0FBaEIsQ0FBc0JDLElBQXRCLENBQTJCQyxTQUEzQixFQUFzQyxDQUF0QyxDQUFwQjtBQUNBLE1BQUlDLGtCQUFrQkQsVUFBVSxDQUFWLENBQXRCO0FBQ0EsTUFBSUUsa0JBQWtCLEVBQXRCO0FBQ0EsT0FBSyxJQUFJQyxDQUFULElBQWNGLGVBQWQsRUFBK0I7QUFDN0JDLG9CQUFnQkMsQ0FBaEIsSUFBcUIsU0FBU0Msb0JBQVQsR0FBaUM7QUFDcEQsVUFBSUMsb0JBQW9CQyxPQUFPQyxNQUFQLENBQWNQLFNBQWQsRUFBeUJMLGFBQXpCLENBQXhCO0FBQ0EsYUFBT00sZ0JBQWdCRSxDQUFoQixFQUFtQkssS0FBbkIsQ0FBeUIsSUFBekIsRUFBK0JILGlCQUEvQixDQUFQO0FBQ0QsS0FIRDtBQUlEO0FBQ0QsU0FBT0gsZUFBUDtBQUNEO0FBQ0QsU0FBU08seUJBQVQsQ0FBb0NDLEVBQXBDLEVBQXdDQyx5QkFBeEMsRUFBbUU7QUFDakUsTUFBSSxDQUFDRCxFQUFMLEVBQVM7QUFBRSxVQUFNLElBQUlFLEtBQUosOENBQU47QUFBK0Q7QUFDMUVELDRCQUEwQkUsT0FBMUIsQ0FBa0MsVUFBQ0MsY0FBRCxFQUFvQjtBQUNwRCxRQUFJLENBQUNKLEdBQUdJLGNBQUgsQ0FBTCxFQUF5QjtBQUN2QixZQUFNLElBQUlGLEtBQUosMEJBQWlDRSxjQUFqQyxpQkFBTjtBQUNEO0FBQ0YsR0FKRDtBQUtEO0FBQ0QsU0FBU0MsYUFBVCxDQUF3QkMsR0FBeEIsRUFBNkJDLFNBQTdCLEVBQTREO0FBQUEsTUFB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LE9BQUQsQ0FBbEI7QUFDRCxLQWREO0FBZUQsR0FsRWM7QUFtRWZFLDJCQUF5QixpQ0FBVTNELEVBQVYsRUFBYztBQUNyQ0QsOEJBQTBCQyxFQUExQixFQUE4QixDQUFDLEtBQUQsQ0FBOUI7QUFDQSxXQUFPLFNBQVM0RCxZQUFULENBQXVCQyxDQUF2QixFQUEwQjtBQUMvQjdELFNBQUdjLEdBQUgsQ0FBTyxjQUFQLEVBQXVCK0MsQ0FBdkI7QUFDQSxZQUFNLElBQUkzRCxLQUFKLENBQVUyRCxDQUFWLENBQU47QUFDRCxLQUhEO0FBSUQ7QUF6RWMsQ0FBakIiLCJmaWxlIjoiamVzdXMuZXM2Iiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgUiA9IHJlcXVpcmUoJ3JhbWRhJylcbi8vIGNvbnN0IGplc3VzID0gcmVxdWlyZSgnamVzdXMnKVxuY29uc3QgdXVpZFY0ID0gcmVxdWlyZSgndXVpZC92NCcpXG5mdW5jdGlvbiBzZXRQYWNrYWdlQXJnc092ZXJ3cml0ZSAoKSB7XG4gIHZhciBvdmVyd3JpdGVBcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKVxuICB2YXIgb3JpZ2luYWxQYWNrYWdlID0gYXJndW1lbnRzWzBdXG4gIHZhciBtb2RpZmllZFBhY2thZ2UgPSB7fVxuICBmb3IgKHZhciBpIGluIG9yaWdpbmFsUGFja2FnZSkge1xuICAgIG1vZGlmaWVkUGFja2FnZVtpXSA9IGZ1bmN0aW9uIHBhY2thZ2VBcmdzT3ZlcndyaXRlICgpIHtcbiAgICAgIHZhciBtb2RpZmllZEFyZ3VtZW50cyA9IE9iamVjdC5hc3NpZ24oYXJndW1lbnRzLCBvdmVyd3JpdGVBcmdzKVxuICAgICAgcmV0dXJuIG9yaWdpbmFsUGFja2FnZVtpXS5hcHBseSh0aGlzLCBtb2RpZmllZEFyZ3VtZW50cylcbiAgICB9XG4gIH1cbiAgcmV0dXJuIG1vZGlmaWVkUGFja2FnZVxufVxuZnVuY3Rpb24gY2hlY2tSZXF1aXJlZERlcGVuZGVuY2llcyAoREksIHJlcXVpcmVkRGVwZW5kZW5jaWVzTmFtZXMpIHtcbiAgaWYgKCFESSkgeyB0aHJvdyBuZXcgRXJyb3IoYFJlcXVpcmVkIERlcGVuZGVuY2llcyBDb250YWluZXIgaXMgbWlzc2luZ2ApIH1cbiAgcmVxdWlyZWREZXBlbmRlbmNpZXNOYW1lcy5mb3JFYWNoKChkZXBlbmRlbmN5TmFtZSkgPT4ge1xuICAgIGlmICghRElbZGVwZW5kZW5jeU5hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFJlcXVpcmVkIERlcGVuZGVuY3kgJHtkZXBlbmRlbmN5TmFtZX0gaXMgbWlzc2luZ2ApXG4gICAgfVxuICB9KVxufVxuZnVuY3Rpb24gY2hlY2tSZXF1aXJlZCAoT0JKLCBwcm9wTmFtZXMsIFBBQ0tBR0UgPSAndW5rbm93Jykge1xuICBpZiAoIU9CSiAmJiBwcm9wTmFtZXMubGVuZ3RoKSB7IHRocm93IG5ldyBFcnJvcihgUEFDS0FHRSAke1BBQ0tBR0V9IC0+IFJlcXVpcmVkIERlcGVuZGVuY2llcyBDb250YWluZXIgaXMgbWlzc2luZ2ApIH1cbiAgcHJvcE5hbWVzLmZvckVhY2goKHByb3BOYW1lKSA9PiB7XG4gICAgaWYgKCFPQkpbcHJvcE5hbWVdKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFBBQ0tBR0UgJHtQQUNLQUdFfSAtPiBSZXF1aXJlZCBEZXBlbmRlbmN5ICR7cHJvcE5hbWV9IGlzIG1pc3NpbmdgKVxuICAgIH1cbiAgfSlcbiAgcmV0dXJuIFIuY2xvbmUoT0JKKVxufVxuZnVuY3Rpb24gZGVidWcgKCkge1xuICBjb25zb2xlLmxvZygnXFx1MDAxYlsxOzMzbScgK1xuICAgICc8U3RhdGUgTXV0YXRpb25zPicgK1xuICAgICdcXHUwMDFiWzBtJylcbiAgY29uc29sZS5sb2cuYXBwbHkoY29uc29sZSwgYXJndW1lbnRzKVxufVxuXG5tb2R1bGUuZXhwb3J0cyA9IHtcbiAgYXN5bmNSZXNwb25zZTogZnVuY3Rpb24gKCkge1xuICAgIHJldHVybiB7fVxuICB9LFxuICBnZXRWYWx1ZVByb21pc2U6IGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICBQcm9taXNlLnJlc29sdmUodmFsdWUpLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgIGlmICh0eXBlb2YgKHZhbHVlKSA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICAgIHRyeSB7IHJlc29sdmUodmFsdWUoKSkgfSBjYXRjaCAoZXJyb3IpIHsgcmVqZWN0KGVycm9yKSB9XG4gICAgICAgIH0gZWxzZSByZXNvbHZlKHZhbHVlKVxuICAgICAgfSlcbiAgICB9KVxuICB9LFxuICBjaGVja1JlcXVpcmVkLFxuICBjaGVja1JlcXVpcmVkRGVwZW5kZW5jaWVzLFxuICBjcmVhdGVOZXdJZHM6IFIuY29tcG9zZShSLm1hcCgoKSA9PiB1dWlkVjQoKSksIFIucmVwZWF0KHRydWUpKSxcbiAgZGVidWcsXG4gIC8vIGRlYnVnLFxuICBhZGRPYmplY3RDb2x1bW46IGZ1bmN0aW9uIChvYmplY3RzQXJyYXksIGNvbHVtbk5hbWUsIHZhbHVlc0FycmF5KSB7XG4gICAgdmFyIGFkZENvbHVtcyA9ICh2YWwsIGluZGV4KSA9PiBSLm1lcmdlKHtcbiAgICAgIFtjb2x1bW5OYW1lXTogdmFsdWVzQXJyYXlbaW5kZXhdXG4gICAgfSwgdmFsKVxuICAgIHJldHVybiBSLmFkZEluZGV4KFIubWFwKShhZGRDb2x1bXMsIG9iamVjdHNBcnJheSlcbiAgfSxcbiAgZ2V0U3RvcmFnZVBhY2thZ2U6IFIuY3VycnkoKHN0b3JhZ2UsIGNvbGxlY3Rpb24pID0+IHtcbiAgICByZXR1cm4gcmVxdWlyZSgnamVzdXMvc3RvcmFnZS4nICsgc3RvcmFnZS50eXBlKShzdG9yYWdlLCBjb2xsZWN0aW9uKVxuICB9KSxcbiAgZ2V0TG9nRnVuY3Rpb25PbGQ6IGZ1bmN0aW9uIChESSkge1xuICAgIGNoZWNrUmVxdWlyZWREZXBlbmRlbmNpZXMoREksIFsnc3RvcmFnZSddKVxuICAgIHJldHVybiBSLmN1cnJ5KChjb250ZXh0LCB0eXBlLCBvYmplY3QpID0+IHtcbiAgICAgIHZhciBjb250ZXh0U3RyaW5nID0gY29udGV4dC5qb2luKCcgPiAnKVxuICAgICAgdmFyIHRpbWUgPSBEYXRlLm5vdygpXG4gICAgICB2YXIgcmVhZGFibGVUaW1lID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1QvLCAnICcpLnJlcGxhY2UoL1xcLi4rLywgJycpXG4gICAgICBpZiAodHlwZSA9PT0gJ0VSUk9SJykge1xuICAgICAgICBjb25zb2xlLmxvZyhgXFx1MDAxYlsxOzMzbSAke3R5cGV9ICggJHtjb250ZXh0U3RyaW5nfSApIFxcdTAwMWJbMG1gKVxuICAgICAgICBjb25zb2xlLmxvZyhvYmplY3QpXG4gICAgICAgIGNvbnNvbGUudHJhY2Uob2JqZWN0KVxuICAgICAgfVxuICAgICAgREkuc3RvcmFnZS5pbnNlcnQoW1xuICAgICAgICB7XG4gICAgICAgICAgdHlwZSxcbiAgICAgICAgICByZWFkYWJsZVRpbWUsXG4gICAgICAgICAgY29udGV4dCxcbiAgICAgICAgICBvYmplY3QsXG4gICAgICAgICAgdGltZVxuICAgICAgICB9XG4gICAgICBdKVxuICAgIH0pXG4gIH0sXG4gIGdldExvZ0Z1bmN0aW9uOiBmdW5jdGlvbiAoREkpIHtcbiAgICBjaGVja1JlcXVpcmVkRGVwZW5kZW5jaWVzKERJLCBbJ3N0b3JhZ2UnXSlcbiAgICByZXR1cm4gZnVuY3Rpb24gbG9nIChsb2dEYXRhKSB7XG4gICAgICBsb2dEYXRhID0gUi5tZXJnZShsb2dEYXRhLCB7XG4gICAgICAgIHJlYWRhYmxlVGltZTogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLnJlcGxhY2UoL1QvLCAnICcpLnJlcGxhY2UoL1xcLi4rLywgJycpLFxuICAgICAgICB0eXBlOiAnTE9HJyxcbiAgICAgICAgdGltZTogRGF0ZS5ub3coKSxcbiAgICAgICAgZGF0YToge31cbiAgICAgIH0pXG4gICAgICBpZiAobG9nRGF0YS50eXBlID09PSAnRVJST1InKSB7XG4gICAgICAgIHZhciBjb250ZXh0U3RyaW5nID0gbG9nRGF0YS5jb250ZXh0LmpvaW4oJyA+ICcpXG4gICAgICAgIGNvbnNvbGUubG9nKGBcXHUwMDFiWzE7MzNtICR7bG9nRGF0YS50eXBlfSAoICR7Y29udGV4dFN0cmluZ30gKSBcXHUwMDFiWzBtYClcbiAgICAgICAgY29uc29sZS5sb2cobG9nRGF0YS5kYXRhKVxuICAgICAgICBjb25zb2xlLnRyYWNlKGxvZ0RhdGEuZGF0YSlcbiAgICAgIH1cbiAgICAgIERJLnN0b3JhZ2UuaW5zZXJ0KFtsb2dEYXRhXSlcbiAgICB9XG4gIH0sXG4gIGdldFNlcnZpY2VFcnJvckZ1bmN0aW9uOiBmdW5jdGlvbiAoREkpIHtcbiAgICBjaGVja1JlcXVpcmVkRGVwZW5kZW5jaWVzKERJLCBbJ2xvZyddKVxuICAgIHJldHVybiBmdW5jdGlvbiBzZXJ2aWNlRXJyb3IgKGUpIHtcbiAgICAgIERJLmxvZygnc2VydmljZUVycm9yJywgZSlcbiAgICAgIHRocm93IG5ldyBFcnJvcihlKVxuICAgIH1cbiAgfVxufVxuIl19